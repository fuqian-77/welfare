function myDeleteNode(pmyTree1){if(pmyTree1.identityfield==undefined){pmyTree1.identityfield="sysid";}tree1=$("#"+pmyTree1.id);var node=tree1.tree("getSelected");pmyTree1.lastnode=null;if(node==null&&node.id=="*"){return pmyTree1;}sysid=eval("node."+pmyTree1.identityfield);var orderno=node.orderno;var msg="["+node.text+"]@n@n是否确定删除";if(node.isparentflag==1){msg+="这级目录？";}else{msg+="这个目录？";}$.messager.confirm({title:"系统提示",msg:myConfirmMessage(msg),width:350,fn:function(r){if(r){var cnodes=tree1.tree("getChildren",node.target);if(cnodes.length>0){var delta=cnodes.length+1;orderno=1*cnodes[cnodes.length-1].orderno;}else{delta=1;orderno=1*node.orderno;}var sql="delete "+pmyTree1.tablename+" where "+pmyTree1.identityfield+"="+sysid+"\n";sql+="update "+pmyTree1.tablename+" set orderno=orderno-"+delta+" where orderno>"+orderno+"\n";sql+=" and "+pmyTree1.identityfield+" in (select "+pmyTree1.identityfield+" from ("+pmyTree1.sql+") as p)";if(node.isparentflag==1){sql+="\n delete "+pmyTree1.tablename+" where ancester like '"+node.ancester+node.id+"#%'\n";sql+=" and "+pmyTree1.identityfield+" in (select "+pmyTree1.identityfield+" from ("+pmyTree1.sql+") as p)";}myRunUpdateSql("",sql);var newnode=myFindTreeNode(pmyTree1.id,node);if(newnode.nextnode!=null){var node1=newnode.nextnode;}else{if(newnode.priornode!=null){var node1=newnode.priornode;}else{var node1=newnode.parentnode;if(node1!=null){sql="update "+pmyTree1.tablename+" set isparentflag=0 where "+pmyTree1.keyfield+"='"+node1.id+"'\n";sql+=" and "+pmyTree1.identityfield+" in (select "+pmyTree1.identityfield+" from ("+pmyTree1.sql+") as p)";myRunUpdateSql("",sql);node1.isparentflag=0;tree1.tree("update",node1);}}}tree1.tree("remove",node.target);n=0;var roots=tree1.tree("getRoots");for(i=0;i<roots.length;i++){if(1*roots[i].orderno>orderno){roots[i].orderno=1*root[i].orderno-delta;tree1.tree("update",roots[i]);n++;}var cnodes=tree1.tree("getChildren",roots[i].target);for(j=0;j<cnodes.length;j++){if(1*cnodes[j].orderno>orderno){cnodes[j].orderno=1*cnodes[j].orderno-delta;tree1.tree("update",cnodes[j]);n++;}}}if(node1!=null){tree1.tree("select",node1.target);}}}});return pmyTree1;}function myMoveTreeNode(t,m){if(t.identityfield==undefined){t.identityfield="sysid";}tree1=$("#"+t.id);t.lastnode=null;var d=tree1.tree("getSelected");var s=tree1.tree("getParent",d.target);if(d.id=="*"||s==null){return t;}var b=null;var q=tree1.tree("getChildren",s.target);var o=[];for(var r=0;r<q.length;r++){if(q[r].level==d.level){o.push(q[r]);}}for(var r=0;r<o.length;r++){if(o[r].id==d.id){if(r>0&&m=="up"){b=o[r-1];}else{if(r<o.length-1&&m=="down"){b=o[r+1];}}break;}}if(b!=null){var h=d.orderno1;var g=b.orderno2;var x=tree1.tree("getChildren",d.target);var v=tree1.tree("getChildren",b.target);var l=x.length+1;var k=v.length+1;var f=d.id;var e=b.id;var w=d.ancester+d.id+"#%";var u=b.ancester+b.id+"#%";if(m=="up"){var c=tree1.tree("getData",d.target);tree1.tree("remove",d.target);tree1.tree("insert",{before:b.target,data:c});d=tree1.tree("find",f);var x=tree1.tree("getChildren",d.target);d.orderno=1*d.orderno-k;tree1.tree("update",d);b.orderno=1*b.orderno+l;tree1.tree("update",b);for(r=0;r<x.length;r++){x[r].orderno=1*x[r].orderno-k;tree1.tree("update",x[r]);}for(r=0;r<v.length;r++){v[r].orderno=1*v[r].orderno+l;tree1.tree("update",v[r]);}sql="update "+t.tablename+" set orderno=orderno-"+k+" where (ancester like '"+w+"' or "+t.keyfield+"='"+f+"')";sql+=" and "+t.identityfield+" in (select "+t.identityfield+" from ("+t.sql+") as p)\n";sql+="update "+t.tablename+" set orderno=orderno+"+l+" where (ancester like '"+u+"' or "+t.keyfield+"='"+e+"')";sql+=" and "+t.identityfield+" in (select "+t.identityfield+" from ("+t.sql+") as p)";}else{if(m=="down"){console.log(d.text,b.text,d.id,b.id,l,k);var a=tree1.tree("getData",b.target);tree1.tree("remove",b.target);tree1.tree("insert",{before:d.target,data:a});b=tree1.tree("find",e);var v=tree1.tree("getChildren",b.target);d.orderno=1*d.orderno+k;tree1.tree("update",d);b.orderno=1*b.orderno-l;tree1.tree("update",b);for(r=0;r<x.length;r++){x[r].orderno=1*x[r].orderno+k;tree1.tree("update",x[r]);}for(r=0;r<v.length;r++){v[r].orderno=1*v[r].orderno-l;tree1.tree("update",v[r]);}sql="update "+t.tablename+" set orderno=orderno+"+k+" where (ancester like '"+w+"' or "+t.keyfield+"='"+f+"')";sql+=" and "+t.identityfield+" in (select "+t.identityfield+" from ("+t.sql+") as p)\n";sql+="update "+t.tablename+" set orderno=orderno-"+l+" where (ancester like '"+u+"' or "+t.keyfield+"='"+e+"')";sql+=" and "+t.identityfield+" in (select "+t.identityfield+" from ("+t.sql+") as p)\n";}}var p=tree1.tree("find",f);if(p){tree1.tree("select",p.target);}console.log(sql);myRunUpdateSql("",sql);}return t;}function myAddTreeNode(h,b){if(h.identityfield==undefined){h.identityfield="sysid";}tree1=$("#"+h.id);var g=tree1.tree("getRoot");var c=tree1.tree("getSelected");h.lastnode=c;var a=c.level;tree1.tree("expand",c.target);if(b=="add"||b=="insert"){var f=tree1.tree("getParent",c.target);}else{var f=c;}if(f!=null&&f.id=="*"){f.orderno=0;}if(b=="insert"){var k=c.orderno;}else{var d=tree1.tree("getChildren",f.target);var e=d.length;var k=d.length+1*f.orderno+1;}console.log(f.orderno,k);console.log(f.id);mySetValue("orderno",k);if(f!=null&&f.id!="*"){mySetValue("parentnodeid",f.id);mySetValue("level",f.level*1+1);mySetValue("ancester",f.ancester+f.id+"#");}else{mySetValue("parentnodeid","");mySetValue("level",1);mySetValue("ancester","");}if(b=="insert"){tree1.tree("insert",{before:c.target,data:[{id:"_"+f.id,text:""}]});}else{b="add";tree1.tree("append",{parent:f.target,data:[{id:"_"+f.id,text:""}]});}var c=tree1.tree("find","_"+f.id);tree1.tree("select",c.target);h.addoredit=b;return h;}function mySaveTreeNode(pmyTree1,eid){if(pmyTree1.identityfield==undefined){pmyTree1.identityfield="sysid";}tree1=$("#"+pmyTree1.id);var node=$("#myTree1").tree("getSelected");var addoredit=eid;var orderno=myGetValue("orderno");var sysid=myGetValue(pmyTree1.identityfield);var pid=myGetValue("parentnodeid");var tmp1=myGetValue("description");mySetValue("description","");if(addoredit=="add"||addoredit=="insert"){mySetValue("isparentflag",0);mySetValue(pmyTree1.keyfield,"");sql=myGenInsertSql("",pmyTree1.tablename);console.log(1,sql);var result=myRunUpdateSql("",sql);console.log(result);sysid=result.identity;sql="update "+pmyTree1.tablename+" set orderno=orderno+1 where orderno>="+orderno;sql+=" and "+pmyTree1.identityfield+" in (select "+pmyTree1.identityfield+" from ("+pmyTree1.sql+") as p)\n";sql+="update "+pmyTree1.tablename+" set "+pmyTree1.keyfield+"='"+sysid+"',orderno="+orderno+" where "+pmyTree1.identityfield+"="+sysid;if(pid!="*"){sql+="\n update "+pmyTree1.tablename+" set isparentflag=1 where isparentflag=0 and "+pmyTree1.keyfield+"='"+pid+"'";sql+=" and "+pmyTree1.identityfield+" in (select "+pmyTree1.identityfield+" from ("+pmyTree1.sql+") as p)\n";}console.log(2,sql);myRunUpdateSql("",sql);date1=myLocalTime("sec");n=0;var roots=tree1.tree("getRoots");for(var i=0;i<roots.length;i++){if(1*roots[i].orderno>=node.orderno&&roots[i].id!=sysid&&roots[i].id!="*"){roots[i].orderno=1*roots[i].orderno+1;tree1.tree("update",roots[i]);console.log(roots[i].text);n++;}var cnodes=tree1.tree("getChildren",roots[i].target);for(var j=0;j<cnodes.length;j++){if(1*cnodes[j].orderno>=node.orderno&&cnodes[j].id!=sysid){cnodes[j].orderno=1*cnodes[j].orderno+1;tree1.tree("update",cnodes[j]);console.log(cnodes[j].text);n++;}if(cnodes[j].id==pid){cnodes[j].isparentflag=1;tree1.tree("update",cnodes[j]);}}}console.log("n="+n);date2=myLocalTime("sec");console.log(date2-date1);}else{sql=myGenUpdateSql("",pmyTree1.tablename,pmyTree1.identityfield);console.log(sql);myRunUpdateSql("",sql);}sql="select * from ("+pmyTree1.sql+") as p where "+pmyTree1.identityfield+"="+sysid;console.log(3,sql);var rs=myRunSelectSql("",sql);mySetValue("orderno",orderno);node=mySetRecordValuebyJson(node,rs[0]);node.text=rs[0].text;node.level=rs[0].level;node.parentnodeid=rs[0].parentnodeid;node.ancester=rs[0].ancester;node.orderno=rs[0].orderno;node.isparentflag=rs[0].isparentflag;node.id=eval("rs[0]."+pmyTree1.keyfield);console.log(rs[0]);eval("node."+pmyTree1.identityfield+"=rs[0].sysid");console.log(node);tree1.tree("update",node);mySetValue("description",tmp1);return pmyTree1;}function myRemoveBlankTreeNode(b,a){if(b.identityfield==undefined){b.identityfield="sysid";}tree1=$("#"+b.id);if(b.selectednode!=null&&b.selectednode.text==""){pnode=tree1.tree("getParent",b.selectednode.target);tree1.tree("remove",b.selectednode.target);if(a!="edit"&&b.lastnode!=null){tree1.tree("select",b.lastnode.target);}else{if(pnode!=null){tree1.tree("select",pnode.target);}}}return b;}