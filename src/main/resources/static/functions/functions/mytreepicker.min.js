Ext.define("Ext.ux.MyTreePicker",{extend:"Ext.form.field.Picker",xtype:"mytreepicker",alias:"widget.mytreepicker",uses:["Ext.tree.Panel"],triggerCls:Ext.baseCSSPrefix+"form-arrow-trigger",config:{store:null,displayField:null,columns:null,selectOnTab:true,maxPickerHeight:300,minPickerHeight:100,valueField:null,xsearchFields:["id","text"],searchFields:[],queryDelay:500,minChars:4,xvalue:"",rootVisible:true,useArrows:true,clearbar:true,leafSelectOnly:false,showFullPath:false,multiSelect:false,selectOnFocus:true},setSearchFields:function(a){var b=this;if(Ext.isEmpty(b.searchFields)){b.searchFields=new Array();}if(!Ext.isEmpty(a)&&(Ext.typeOf(a)=="string"||Ext.typeOf(a)=="array")){b.searchFields=Ext.Array.merge(b.searchFields,a);}},initComponent:function(){var a=this;a.callParent(arguments);a.addEvents("select");a.mon(a.store,{scope:a,load:a.onLoad,beforeload:a.onBeforeLoad,update:a.onUpdate});if(Ext.isEmpty(a.valueField)){a.displayField="text";}if(Ext.isEmpty(a.valueField)){a.valueField=a.displayField;}if(a.showFullPath===true){a.setEditable(false);}a.doQueryTask=new Ext.util.DelayedTask(a.doRawQuery,a);},createPicker:function(){var c=this,b=new Ext.tree.Panel({shrinkWrapDock:2,store:c.store,floating:true,displayField:c.displayField,columns:c.columns,minHeight:c.minPickerHeight,maxHeight:c.maxPickerHeight,manageHeight:true,shadow:false,rootVisible:c.rootVisible,useArrows:c.useArrows,animate:false,emptyText:"找不到匹配的记录",autoScroll:true,listeners:{scope:c,itemclick:c.onItemClick},viewConfig:{listeners:{scope:c,render:c.onViewRender}}}),a=b.getView();if(c.clearbar){var d=new Ext.toolbar.Toolbar({dock:"bottom",items:["->",{text:"清空",iconCls:"deletefileIcon",handler:function(){c.clearValue();}}]});b.addDocked(d);}if(Ext.isIE9&&Ext.isStrict){a.on({scope:c,highlightitem:c.repaintPickerView,unhighlightitem:c.repaintPickerView,afteritemexpand:c.repaintPickerView,afteritemcollapse:c.repaintPickerView});}return b;},onViewRender:function(a){a.getEl().on("keypress",this.onPickerKeypress,this);},repaintPickerView:function(){var a=this.picker.getView().getEl().dom.style;a.display=a.display;},alignPicker:function(){var b=this,a;if(b.isExpanded){a=b.getPicker();if(b.matchFieldWidth){a.setWidth(b.bodyEl.getWidth());}if(a.isFloating()){b.doAlign();}}},onItemClick:function(b,a,c,f,d){this.selectItem(a);},onPickerKeypress:function(c,b){var a=c.getKey();if(a===c.ENTER||(a===c.TAB&&this.selectOnTab)){this.selectItem(this.picker.getSelectionModel().getSelection()[0]);}},selectItem:function(a){var e=this,c=e.getPicker();if(e.leafSelectOnly===true&&!a.get("leaf")){e.xclearValue();}else{e.setValue(a.get(e.valueField));}if(!Ext.isEmpty(a.get("checked"))){if(c){var b=c.getChecked();Ext.each(b,function(f){if(!Ext.isEmpty(f.get("checked"))){f.set("checked",false);}});}a.set("checked",true);var d=a.parentNode;while(!Ext.isEmpty(d)){if(!Ext.isEmpty(d.get("checked"))){d.set("checked",true);}d=d.parentNode;}}e.collapse();e.inputEl.focus();e.fireEvent("select",e,a);},onExpand:function(){var d=this,b=d.picker,a=b.store,e=d.value,c;if(e){c=d.findRecord(e);}if(!c){c=a.getRootNode();}b.selectPath(c.getPath());Ext.defer(function(){b.getView().focus();},1);},setValue:function(g,d){console.log("#0**"+this.name+'.setValue("'+g+'") me.xvalue=['+this.xvalue+"]value=["+g+"]doQuery=["+d+"]**");var e=this,b,f=e.searchFields,a=e.getPicker().getSelectionModel().getSelection();if(!Ext.isEmpty(g)){g=Ext.String.trim(g);}e.value=g;if(e.store.loading){return e;}b=Ext.isEmpty(g)?undefined:e.findRecord(g);if(Ext.isEmpty(b)){if(d===true){e.xvalue=undefined;}if(e.xvalue!=g){var c;if(d===true){var i=new Array();Ext.each(f,function(j){i.push(j+" LIKE '%"+g+"%'");});i=i.join(" OR ");c={"searchText":i};}else{c={"selectedCode":g};}e.store.load({params:c});e.xvalue=g;}else{e.value=g;e.setRawValue(g);}}else{e.value=b.get(e.valueField);if(e.isExpanded&&!Ext.Array.contains(a,b)){e.onExpand();}if(e.leafSelectOnly===true&&!b.get("leaf")){e.xclearValue();}else{if(e.showFullPath){var h=e.store.getRootNode().raw.text;e.setRawValue(b.getPath(e.displayField,"-").replace("-"+h+"-",""));}else{e.setRawValue(b.get(e.displayField));}}}return e;},clearValue:function(){var a=this;a.xvalue=undefined;a.setValue("");},xclearValue:function(){var a=this;a.xvalue=undefined;a.value="";a.setRawValue("");},findRecord:function(d){var c=this,e=Ext.Array.merge(c.displayField,c.searchFields,c.xsearchFields),a=c.store.getRootNode();if(Ext.isEmpty(d)){return null;}var b=a.findChild(c.valueField,d);if(Ext.isEmpty(b)){b=a.findChild(c.displayField,d);}if(Ext.isEmpty(b)){Ext.Array.each(c.xsearchFields,function(f){b=a.findChild(f,d);if(b){return false;}});}if(Ext.isEmpty(b)){b=a.findChildBy(function(g){var f;Ext.Array.each(e,function(h){var i=g.data[h];f=-1;if(!Ext.isEmpty(i)){f=i.indexOf(d);if(f>=0){return false;}}});if(f>=0){return true;}},c,true);}return b;},getSubmitValue:function(){return this.value;},getValue:function(){var a=this;if(a.value==undefined){a.value="";}return this.value;},onLoad:function(b,d,a){var c=this;var e=c.value;if(d.isRoot()){if(e){c.setValue(e);}else{c.setRawValue("");}}if(c.loadMask){c.loadMask.hide();}},onBeforeLoad:function(){var a=this;a.loadMask=a.getPicker().view.setLoading("正在加载……");},onUpdate:function(a,e,b,c){var d=this.displayField;if(b==="edit"&&c&&Ext.Array.contains(c,d)&&this.value===e.getId()){this.setRawValue(e.get(d));}},initEvents:function(){var a=this;a.callParent();if(!a.enableKeyEvents){a.mon(a.inputEl,"keyup",a.onKeyUp,a);}a.mon(a.inputEl,"paste",a.onPaste,a);},onKeyUp:function(f,b){var c=this,a=f.getKey(),d=c.getRawValue();if(!c.readOnly&&!c.disabled&&c.editable){if(a==Ext.EventObject.ENTER){c.doQueryTask.delay(c.queryDelay);}}if(c.enableKeyEvents){c.callParent(arguments);}},onPaste:function(){var a=this;if(!a.readOnly&&!a.disabled&&a.editable){a.doQueryTask.delay(a.queryDelay);}},doRawQuery:function(){var a=this;a.setValue(a.getRawValue(),true);a.expand();}});